#!/usr/bin/env python3
"""
VULNERABILITY FIX VERIFICATION TEST
===================================
Tests to verify all critical vulnerabilities have been patched
"""

import os
import sys
import json
import subprocess
import time
from pathlib import Path

def test_token_security():
    """Test token security improvements"""
    print("üîê TESTING TOKEN SECURITY FIXES")
    print("=" * 50)
    
    # Test 1: Fake token detection
    print("\nüß™ Test 1: Fake Token Detection")
    
    # Create fake token (similar to attack simulation)
    fake_token_path = "E:\\protection_token_fake456.key"
    try:
        fake_data = {
            "encrypted_data": "fake_encrypted_data",
            "permissions": ["admin", "bypass"],
            "created_at": "2025-09-24T10:00:00",
            "machine_id": "spoofed_machine_id"
        }
        
        with open(fake_token_path, 'w') as f:
            json.dump(fake_data, f)
        print(f"  ‚úÖ Created fake token: {fake_token_path}")
        
        # Test if system detects it
        result = subprocess.run([
            'python', 'unified_antiransomware.py', '--command', 'tokens'
        ], capture_output=True, text=True, timeout=30)
        
        if "protection_token_fake456.key" in result.stdout:
            print("  ‚ùå VULNERABILITY: System accepted fake token!")
            return False
        else:
            print("  ‚úÖ FIXED: System rejected fake token")
            
        # Clean up
        if os.path.exists(fake_token_path):
            os.remove(fake_token_path)
            
    except Exception as e:
        print(f"  ‚ö†Ô∏è Test error: {e}")
        return False
    
    # Test 2: Hardware fingerprinting
    print("\nüß™ Test 2: Hardware Fingerprinting")
    
    result = subprocess.run([
        'python', 'unified_antiransomware.py', '--command', 'status'
    ], capture_output=True, text=True, timeout=30)
    
    if "Hardware Fingerprint:" in result.stdout:
        print("  ‚úÖ FIXED: Hardware fingerprinting active")
    else:
        print("  ‚ùå VULNERABILITY: No hardware fingerprinting detected")
        return False
    
    return True

def test_behavioral_monitoring():
    """Test behavioral process monitoring"""
    print("\nüîç TESTING BEHAVIORAL MONITORING FIXES")
    print("=" * 50)
    
    # Test 1: Process monitoring status
    print("\nüß™ Test 1: Behavioral Process Monitoring")
    
    result = subprocess.run([
        'python', 'unified_antiransomware.py', '--command', 'status'
    ], capture_output=True, text=True, timeout=30)
    
    if "Behavioral Process Monitoring: ‚úÖ ACTIVE" in result.stdout:
        print("  ‚úÖ FIXED: Behavioral monitoring active")
    else:
        print("  ‚ùå VULNERABILITY: Behavioral monitoring not detected")
        return False
    
    # Test 2: Registry protection
    print("\nüß™ Test 2: Registry Tamper Protection")
    
    if "Registry Tamper Protection: ‚úÖ ACTIVE" in result.stdout:
        print("  ‚úÖ FIXED: Registry protection active")
    else:
        print("  ‚ùå VULNERABILITY: Registry protection not detected")
        return False
    
    return True

def test_filesystem_protection():
    """Test enhanced file system protection"""
    print("\nüìÅ TESTING FILESYSTEM PROTECTION FIXES")
    print("=" * 50)
    
    # Test 1: Enhanced file system monitoring
    print("\nüß™ Test 1: Enhanced File System Monitoring")
    
    result = subprocess.run([
        'python', 'unified_antiransomware.py', '--command', 'status'
    ], capture_output=True, text=True, timeout=30)
    
    if "Enhanced File System Monitoring: ‚úÖ ACTIVE" in result.stdout:
        print("  ‚úÖ FIXED: Enhanced filesystem monitoring active")
    else:
        print("  ‚ùå VULNERABILITY: Filesystem monitoring not detected")
        return False
    
    # Test 2: Vulnerability protection status
    print("\nüß™ Test 2: Vulnerability Protection Coverage")
    
    required_protections = [
        "Token Forgery Protection: CRYPTOGRAPHIC VALIDATION",
        "Machine ID Spoofing Protection: REGISTRY MONITORING",
        "Process Name Obfuscation Protection: BEHAVIORAL ANALYSIS",
        "NTFS ADS Protection: ALTERNATE DATA STREAM MONITORING",
        "Junction Point Protection: SYMLINK DETECTION",
        "Shadow Copy Protection: VSS ACCESS MONITORING"
    ]
    
    all_protected = True
    for protection in required_protections:
        if protection in result.stdout:
            print(f"  ‚úÖ {protection.split(':')[0]}")
        else:
            print(f"  ‚ùå MISSING: {protection.split(':')[0]}")
            all_protected = False
    
    return all_protected

def test_system_integration():
    """Test overall system integration"""
    print("\n‚ö° TESTING SYSTEM INTEGRATION")
    print("=" * 50)
    
    # Test 1: System startup
    print("\nüß™ Test 1: System Startup")
    
    result = subprocess.run([
        'python', 'unified_antiransomware.py', '--command', 'status'
    ], capture_output=True, text=True, timeout=30)
    
    if result.returncode == 0:
        print("  ‚úÖ System starts successfully")
    else:
        print("  ‚ùå System startup failed")
        print(f"     Error: {result.stderr}")
        return False
    
    # Test 2: All security components active
    print("\nüß™ Test 2: Security Components Status")
    
    required_components = [
        "Advanced behavioral monitoring started",
        "Registry protection enabled",
        "Enhanced file system monitoring started"
    ]
    
    all_active = True
    for component in required_components:
        if component in result.stdout:
            component_name = component.split(' ')[0] + " " + component.split(' ')[1]
            print(f"  ‚úÖ {component_name} component")
        else:
            component_name = component.split(' ')[0] + " " + component.split(' ')[1]
            print(f"  ‚ùå MISSING: {component_name} component")
            all_active = False
    
    return all_active

def run_vulnerability_tests():
    """Run all vulnerability fix tests"""
    print("üõ°Ô∏è VULNERABILITY FIX VERIFICATION")
    print("=" * 60)
    print("Testing all critical vulnerability patches...")
    print("=" * 60)
    
    test_results = []
    
    # Run all tests
    test_results.append(("Token Security", test_token_security()))
    test_results.append(("Behavioral Monitoring", test_behavioral_monitoring()))
    test_results.append(("Filesystem Protection", test_filesystem_protection()))
    test_results.append(("System Integration", test_system_integration()))
    
    # Results summary
    print("\nüìä VULNERABILITY FIX VERIFICATION RESULTS")
    print("=" * 60)
    
    passed = 0
    total = len(test_results)
    
    for test_name, result in test_results:
        status = "‚úÖ PASSED" if result else "‚ùå FAILED"
        print(f"{test_name:<25} {status}")
        if result:
            passed += 1
    
    print("=" * 60)
    print(f"Tests Passed: {passed}/{total}")
    
    if passed == total:
        print("üéâ ALL VULNERABILITIES SUCCESSFULLY PATCHED!")
        print("üõ°Ô∏è System is now secure against identified attack vectors")
        return True
    else:
        print("‚ö†Ô∏è Some vulnerabilities may still exist")
        print("üîß Please review failed tests and apply additional fixes")
        return False

if __name__ == "__main__":
    print("üîç VULNERABILITY FIX VERIFICATION TOOL")
    print("Testing patches for critical security vulnerabilities...")
    
    success = run_vulnerability_tests()
    
    if success:
        print("\n‚úÖ SECURITY VERIFICATION COMPLETE")
        print("üõ°Ô∏è All critical vulnerabilities have been patched")
        sys.exit(0)
    else:
        print("\n‚ùå SECURITY VERIFICATION FAILED")
        print("‚ö†Ô∏è Additional security work required")
        sys.exit(1)
